<!DOCTYPE html>
<html lang="ko">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Page</title>
    <link rel="stylesheet" href="{% static 'chat/css/chat.css' %}">
    <!--<link rel="icon" href="favicon.png" />-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
</head>

<body style = "margin:0px">
    <div class="header">
        <a href= "board/board.html">
            <span class="material-symbols-outlined" id="back">
            arrow_back_ios_new
            </span>
        </a>
        <div style="padding-right: 50px;">
            채팅방
        </div>
        <div></div>
    <!-- n -->
    </div>

    <div class="chat-container">
        <div class="chat-box">
            <div class="chat-header">
                <h3 style="margin-top:0px;">채팅방{{ room_name_json }}</h3>
            </div>
            <div class="chat-content">
                <div class="message">
                    <div class="profile">
                        <img src="https://i.imgur.com/ooRMUd8.png" width="50px" height="50px" alt="Profile">
                    </div>
                    <div class="text" id="chat-messages"></div>
                </div>
            </div>
            <div class="chat-input" style="max-width:72%;">
                <form id="chat-form" method="post" action="{% url 'post_message' room_name=room_name_json %}" style="margin-left:10%; margin-right:10% text-al">
                    {% csrf_token %}
                    <input type="text" id="message-input" name="message" autocomplete="off" required placeholder="메시지를 입력하세요" style="width:75%">
                    <button type="submit" onclick="sendMessage()" style="margin-left: 10px;">전송</button>
                </form>
            </form>
            </div>
        </div>
    </div>
</body>
<script>
    const roomName = '{{ room_name_json }}';
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');

    function displayMessage(message) {
        const messageElement = document.createElement('p');
        messageElement.textContent = `${message.user}: ${message.message}`;
        chatMessages.appendChild(messageElement);
    }

    function getMessages() {
        fetch(`/chat/${roomName}/get_messages/`)
            .then(response => response.json())
            .then(data => {
                chatMessages.innerHTML = '';
                data.messages.forEach(displayMessage);
            });
    }

    chatForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            fetch(`/chat/${roomName}/post_message/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: `message=${encodeURIComponent(message)}`,
            })
            .then(() => {
                messageInput.value = '';
                getMessages();
            });
        }
    });

    getMessages();
    setInterval(getMessages, 5000);  // messages 5초마다 업데이트
</script>


</html>