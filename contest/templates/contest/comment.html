{% extends 'taxi_posts/base.html' %}
{% load static %}

{% block main_area %}
<br><br>
<section class="title" style="top: -170px; transform: none;">
    <div class="wrap">
        <p class="badges">
            <span>{{ contest.contest_category }}</span>
        </p>
        {% if contest.contest_image %}
            <img src="{{ contest.contest_image.url }}" alt="Contest Image">
        {% else %}
            <img src="https://picsum.photos/seed/{{ contest.id }}/800/200" class="card-img-top" alt="random_image">
        {% endif %}
        <div class="content">
            <h1 style="font-size: 20px;">{{ contest.contest_title }}</h1>
            <p class="info">
                <span class="viewcount" style="font-size: 15px;">
                    <span class="material-symbols-outlined" style="font-size: 13px; padding-top: 6px;">
                        visibility
                    </span>
                    {{ contest.contest_view_count }}
                </span>
            </p>
            <a class="scrap">
                <form method="post" action="{% url 'contest_detail' contest.id %}" id="scrapForm">
                    {% csrf_token %}
                    <button type="button" name="scrap" onclick="handleScrap()">
                        <img id="scrapImage" src="{% static 'contest/image/bookmark.png' %}" style="background-color: white; width: 29px;">
                    </button>
                </form>
            </a>
        </div>
    </div>
</section>

<section class="tab">
    <div class="wrap">
        <a href="{% url 'contest_detail' contest.id %}" class="active">
            <span class="text">소개</span>
        </a>
        <a href="{% url 'list_contest' contest.id %}">
            <span class="text">팀원 모집</span>
            <span class="count">{{ contest.prj_set.count }}</span>
        </a>
        <a href="{% url 'comment' contest.id %}" data-menu="comment">
            <span class="text">댓글</span>
            <span class="count">{{ comments_count  }}</span>
        </a>
    </div>
</section>

<div class="container">
    <div class="comments">
        <h4>댓글:</h4>
        {% for comment in comments %}
            <div class="comment">
                <p>
                    {{ comment.comment }} - {{ comment.created_at|date:"F d, Y H:i:s" }} - {{ comment.author.username }}
                    
                    {% if user.is_authenticated and comment.author == user %}
                        <form method="post" action="{% url 'delete_comment' comment.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-link btn-sm text-danger">Delete</button>
                        </form>
                    {% endif %}
                </p>
            </div>
        {% endfor %}
    </div>

    <div class="comment-form">
        <form method="post" action="{% url 'comment' contest.id %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="comment">댓글:</label>
                <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
</div>

<style>
    section.title > div.wrap > div.content > p.info > span {
        display: inline-block;
        margin-right: 8px;
        line-height: 18px;
        color: #a6a6a6;
        font-size: 12px;
        letter-spacing: 0;
    }

    .comments {
        margin-top: 20px;
    }

    .comment {
        margin-bottom: 10px;
    }

    .comment-form {
        margin-top: 20px;
    }
    section.tab > div.wrap > a > span.count {
        margin-left: 4px;
        color: #a6a6a6;
        font-size: 10px;
        font-weight: bold;
        letter-spacing: 0;
    }
    span.commentcount {
        margin-left: 4px;
        color: #a6a6a6;
        font-size: 12px;
        font-weight: bold;
        letter-spacing: 0;
    }
</style>
<script>
    function handleScrap(event) {
        jQuery.ajax({
            url: "{% url 'scrap_contest' contest.id %}",
            method: "POST",
            data: { csrfmiddlewaretoken: '{{ csrf_token }}', contest_id: {{ contest.id }} },
            success: function (data) {
                console.log(data);
                alert(data.message);
                if (data.status === 'success') {
                    // 추가 작업
                }
            },
            error: function (error) {
                console.log(error);
            },
        });
    }
</script>
<script>
    // Function to set the initial state of the scrap button based on localStorage
    function setInitialScrapState() {
        var scrapButton = document.getElementById('scrapImage');
        var storedState = localStorage.getItem('scrapState');

        if (storedState === 'scrap') {
            scrapButton.src = "{% static 'contest/image/bookmark_FILL.png' %}";
        }
    }

    // Function to handle the scrap button click
    function handleScrap() {
        var scrapButton = document.getElementById('scrapImage');
        var csrfToken = '{{ csrf_token }}';

        jQuery.ajax({
            url: "{% url 'scrap_contest' contest.id %}",
            method: "POST",
            data: { csrfmiddlewaretoken: csrfToken, contest_id: {{ contest.id }} },
            success: function (data) {
                console.log(data);
                alert(data.message);

                if (data.status === 'success') {
                    // Toggle the image source
                    if (scrapButton.src.includes('bookmark.png')) {
                        scrapButton.src = "{% static 'contest/image/bookmark_FILL.png' %}";
                        localStorage.setItem('scrapState', 'scrap');
                    } else {
                        scrapButton.src = "{% static 'contest/image/bookmark.png' %}";
                        localStorage.removeItem('scrapState');
                    }
                }
            },
            error: function (error) {
                console.log(error);
            },
        });
    }

    // Call setInitialScrapState when the page is loaded
    document.addEventListener('DOMContentLoaded', setInitialScrapState);
</script>

<link rel="stylesheet" type="text/css" href="{% static 'contest/css/detail.css' %}">

{% endblock %}
