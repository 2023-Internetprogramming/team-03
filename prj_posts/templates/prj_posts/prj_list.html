{% extends 'taxi_posts/base.html' %}

{% block main_area %}
<br><br>
<div class="py-3 mb-4" style="padding-bottom: 0rem!important; margin-bottom: 0rem!important; padding-top: 1.5rem!important;">
  <nav class="navbar bg-body-tertiary" style="padding-left: 10%; width: 90%;">
    <div class="container-fluid">
      <a href="{% url 'prj_list' %}"><h2 class="mb-4" style="margin-bottom: 0rem!important;">Project/Contest</h2></a>
      <form class="d-flex" role="search" method="GET" action="{% url 'prjsearchResult' %}">
        <input class="form-control me-2" type="search" placeholder="검색어 입력..." name="q" value="{{ request.GET.q }}">
        <button class="btn btn-outline-success" type="submit" style="padding-left: 10px; padding-right: 10px; padding-bottom: 2px;">
            <span class="material-symbols-outlined" style="font-size:17px">
                search
            </span>
        </button>
    </form>
    </div>
  </nav>
  <hr style="width: 90%;">
</div>
<div class="container mt-4" id="container" style="margin-top: 1.5rem!important;">
    {% if prjs %}
    <ul class="list-group">
        {% for prj in prjs %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <a href="#" onclick="openDetailPopup('{{ prj.id }}')" style="width: 100%; display: block;">
            {% if prj.contest %}
              [{{ prj.contest.contest_title }}] 공모전 팀원
            {% elif prj.prj_name %}
              {{ prj.prj_name }} 프로젝트 팀원
            {% endif %}
            {% if prj.prj_member == 0 %}
              마감
            {% else %}
              모집 중
            {% endif %}
          </span>
          </a>
          <span>
            <a href="#" onclick="openDetailPopup('{{ prj.id }}')">
              <span class="badge {% if prj.prj_member == 0 %}badge-danger{% else %}badge-info{% endif %}">
                {% if prj.prj_member == 0 %}
                    마감
                {% else %}
                    모집 중
                {% endif %}
              </span>
              </a>
            </span>
        </li>
        <div id="prjDetailModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeDetailPopup()">&times;</span>
            <div id="prjDetailContent"></div>
            <div class="container mt-4 d-flex justify-content-between align-items-end" style="margin-top: 1rem!important;">
              <div>
                <a href="#" onclick="join_user('{{ prj.id }}'); return false;">
                  <div id="join-button">
                    <button id="join"><span>채팅 참여</span></button>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
    </ul>

   <!--페이지네이션-->
   <br><br>
   <nav aria-label="Page navigation example">
     <ul class="pagination d-flex justify-content-center">
       {% if page_obj.has_previous %}
         <li class="page-item">
           <a class="page-link" href="?page=1" aria-label="Previous">
             <span aria-hidden="true">&laquo;</span>
           </a>
         </li>
       {% endif %}
   
       {% for i in page_obj.paginator.page_range %}
         <li class="page-item {% if page_obj.number == i %}active{% endif %}">
           <a class="page-link" href="?page={{ i }}">{{ i }}</a>
         </li>
       {% endfor %}
   
       {% if page_obj.has_next %}
         <li class="page-item">
           <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Next">
             <span aria-hidden="true">&raquo;</span>
           </a>
         </li>
       {% endif %}
     </ul>
   </nav>

   {% else %}
     <h3>아직 게시물이 없습니다.</h3>
   {% endif %}

   <a href="{% url 'prj_create' %}" id="create-button" onclick="event.preventDefault();">
   <span class="material-symbols-outlined" id="plus">
     edit_square
   </span>
 </a>
</div>

<script>
  var prj_id;
  // 모달 열기
  function openDetailPopup(prjId) {
    prj_id = prjId;
    const modal = document.getElementById('prjDetailModal');
    modal.style.display = 'block';

    // AJAX 요청 보내기
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        document.getElementById("prjDetailContent").innerHTML = this.responseText;
      }
    };
    xhttp.open("GET", "{% url 'prj_detail' 0 %}".replace('0', prjId), true);
    xhttp.send();
  }
  function join_user() {
    // AJAX를 이용하여 prj.people 값을 1 줄입니다.
    $.ajax({
      url: prj_id + "/prj_join/",
      method: 'GET',
      success: function (response) {
        if (response.success) {
          // prj.people 값을 성공적으로 줄였으면 채팅 방으로 이동합니다.
          window.location.href = "{{ room_name_json }}" + prj_id;
        } else {
          // 실패한 경우에 대한 처리를 추가할 수 있습니다.
          alert("모집이 마감되었습니다.");
        }
      },
      error: function (xhr, errmsg, err) {
        console.error(xhr.status + ": " + xhr.responseText);
      }
    });
  }

  // 모달 닫기
  function closeDetailPopup() {
    const modal = document.getElementById('prjDetailModal');
    modal.style.display = 'none';
  }
</script>

<script>
  // JavaScript로 로그인 상태 확인 및 알림 창 표시
  document.addEventListener('DOMContentLoaded', function () {
    const createButton = document.getElementById('create-button');

    createButton.addEventListener('click', function () {
      // 사용자가 로그인 상태인지 확인
      {% if user.is_authenticated %}
        window.location.href = '{% url "prj_create" %}';
      {% else %}
        // 로그인 상태가 아닌 경우, 로그인 페이지로 이동
        alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
        window.location.href = '{% url "login" %}';
      {% endif %}
    });

    // 채팅 참여 버튼 클릭 시 로그인 확인
    const joinButton = document.getElementById('join-button');

    joinButton.addEventListener('click', function () {
      // 사용자가 로그인 상태인지 확인
      {% if user.is_authenticated %}
      // 채팅 참여 로직 추가 (여기에 채팅 참여 코드를 넣으세요)
      join_user('{{ ride.id }}');
      {% else %}
      // 로그인 상태가 아닌 경우, 알림창 표시
      alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
      window.location.href = '{% url "login" %}';
      {% endif %}
    });
  });
</script>

<style>
  .mt-4, .my-4 {
    margin-top: 4.5rem!important;
  }
</style>

{% endblock %}