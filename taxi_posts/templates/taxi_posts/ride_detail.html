{% extends 'taxi_posts/base.html' %}

{% block main_area %}
    <br><br>
    <div class="container mt-4" id="container">
      <h2>{{ ride.departure_location }} -> {{ ride.destination }}
        <span class="badge badge-info">
          {% if ride.available_seats == 0 %}
          마감
          {% else %}
          모집 중
          {% endif %}
        </span>
      </h2>
      <p>시간: {{ ride.departure_time }}</p>
      <p>모집 인원: {{ ride.available_seats }}</p>
      <p>세부 사항: {{ ride.description }}</p>

      <a href="{% url 'ride_update' id=ride.id %}" class="btn btn-secondary {% if request.user != ride.author %}d-none{% endif %}">수정</a>

      <!-- 삭제 버튼에 onclick 이벤트 추가 -->
      <button type="button" class="btn btn-danger {% if request.user != ride.author %}d-none{% endif %}" onclick="confirmDelete()">삭제</button>

      <!-- 삭제 확인 모달 -->
      <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmDeleteModalLabel">삭제 확인</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>게시물을 삭제하시겠습니까?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
              <a href="{% url 'ride_delete' %}?id={{ ride.id }}" class="btn btn-danger">삭제</a>
            </div>
          </div>
        </div>
      </div>
      <a href="{% url 'ride_list' %}" class="btn btn-secondary">목록으로 돌아가기</a>
      <a href="#" onclick="join_user(); return false;">        <div id="join-button">
            <button id="join"><span>채팅 참여</span></button>
        </div>
      </a>
    </div>
    
    <script>
      function confirmDelete() {
        $('#confirmDeleteModal').modal('show');
      }
    </script>
    <script>
      function join_user() {
        // AJAX를 이용하여 ride.available_seats 값을 1 줄입니다.
        $.ajax({
          url: "{% url 'ride_join' id=ride.id %}",
          method: 'GET',
          success: function (response) {
            if (response.success) {
              // ride.available_seats 값을 성공적으로 줄였으면 채팅 방으로 이동합니다.
              window.location.href = "{{ room_name_json }}";
            } else {
              // 실패한 경우에 대한 처리를 추가할 수 있습니다.
              alert("모집이 마감되었습니다.");
            }
          },
          error: function (xhr, errmsg, err) {
            console.error(xhr.status + ": " + xhr.responseText);
          }
        });
      }
    </script>  

{% endblock %}